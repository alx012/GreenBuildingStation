<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OSM å»ºç¯‰ç‰©é«˜åº¦åˆ†æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

  <!-- Turf.js -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <!-- osmtogeojson -->
  <script src="https://unpkg.com/osmtogeojson/osmtogeojson.js"></script>

  <!-- Leaflet Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    body, html { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }
    .summary-button {
      background-color: white;
      border: 1px solid gray;
      padding: 2px 6px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    .summary-box {
      background: white;
      border: 1px solid #ccc;
      padding: 6px;
      border-radius: 5px;
      font-size: 13px;
    }
    .leaflet-control-target {
      background: white;
      padding: 4px 8px;
      font-size: 14px;
      text-decoration: none;
      color: #333;
      cursor: pointer;
    }
    .leaflet-control-target:hover {
      background: #f0f0f0;
    }
    .target-icon {
      font-size: 20px;
      line-height: 24px;
    }

  </style>
</head>
<body>
<div id="map"></div>

<script>
  // å®šç¾©å…¨åŸŸè®Šæ•¸è®“çˆ¶é é¢å¯ä»¥è®€å–
  window.bboxProjectData = [];

  window.resetBboxPolygons = function () {
    drawnItems.clearLayers(); // Leaflet çš„æ–¹å¼æ¸…é™¤åœ–å±¤
    window.bboxProjectData = []; // ä¹Ÿæ¸…ç©ºä½ æ”¾é€²å»çš„å…¨åŸŸè®Šæ•¸
    console.log('å·²é‡ç½® bbox åŒ¡é¸è³‡æ–™');
  }

  const map = L.map('map').setView([25.04, 121.56], 16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);
  L.control.scale({ metric: true, imperial: false }).addTo(map);
  L.Control.geocoder().addTo(map);

  const drawnItems = new L.FeatureGroup().addTo(map);
  const drawControl = new L.Control.Draw({
    draw: { marker: false, polyline: false, rectangle: false, circle: false, circlemarker: false, polygon: true },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);

  // 1) è‡ªè¨‚ control é¡åˆ¥
  const TargetControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function(map) {
      const btn = L.DomUtil.create('a', 'leaflet-control-target');
      btn.innerText = 'ğŸ¯';
      btn.href = '#';
      L.DomEvent
        .on(btn, 'click', L.DomEvent.stopPropagation)
        .on(btn, 'click', L.DomEvent.preventDefault)
        .on(btn, 'click', () => {
          console.log('â–¶ æ¨™çš„å»ºç¯‰ç‰©æŒ‰éˆ•è¢«é»äº†');
          alert('è«‹é»é¸è¦è¨­ç‚ºæ¨™çš„å»ºç¯‰ç‰©çš„å½¢ç‹€ã€‚æ¯å€‹å°ˆæ¡ˆåªèƒ½æœ‰ä¸€å€‹æ¨™çš„å»ºç¯‰ç‰©ã€‚');
          enableTargetMode();
        });
      return btn;
    }
  });
  // 2) æŠŠæŒ‰éˆ•æ”¾åˆ°åœ°åœ–ä¸Š
  map.addControl(new TargetControl());

  map.on(L.Draw.Event.CREATED, async function (event) {
    const layer = event.layer;
    drawnItems.addLayer(layer);
    const geojson = layer.toGeoJSON();
    const coords = geojson.geometry.coordinates[0];
    const bbox = getBoundingBox(coords);

    const query = `
      [out:json][timeout:60];
      (
        way["building"]["height"](${bbox.minLat},${bbox.minLng},${bbox.maxLat},${bbox.maxLng});
        way["building"]["building:levels"](${bbox.minLat},${bbox.minLng},${bbox.maxLat},${bbox.maxLng});
      );
      (._;>;);
      out body;
    `;

    try {
      const res = await fetch("https://overpass.kumi.systems/api/interpreter", { method: "POST", body: query });
      const osmData = await res.json();
      const geojsonData = osmtogeojson(osmData);
      const filtered = geojsonData.features.filter(f => f.geometry && turf.booleanIntersects(f, geojson));
      const enriched = filtered.map(f => {
        const props = f.properties || {};
        const name = props.name || props.building || f.id || "æœªå‘½åå»ºç¯‰";
        let height = parseFloat(props.height);
        const levels = parseInt(props['building:levels']);
        if (isNaN(height) && !isNaN(levels)) height = levels * 3;
        f.properties._name = name;
        f.properties._height = isNaN(height) ? null : height;
        return f;
      });
      const knownHeights = enriched.map(f => f.properties._height).filter(h => h !== null);
      const avg = knownHeights.reduce((a, b) => a + b, 0) / knownHeights.length;
      const min = Math.min(...knownHeights);
      const max = Math.max(...knownHeights);

      const buildingLayer = L.geoJSON(enriched.filter(f => f.geometry?.type === "Polygon"), {
        onEachFeature: (feature, layer) => {
          layer.bindPopup(`${feature.properties._name}<br>${feature.properties._height !== null ? `é«˜åº¦ï¼š${feature.properties._height.toFixed(1)} m` : "é«˜åº¦ï¼šæœªçŸ¥"}`);
        },
        style: f => ({ color: f.properties._height !== null ? '#0077cc' : '#ff6666', weight: 2 })
      }).addTo(map);

      const center = turf.center(geojson).geometry.coordinates;
      const summary = L.marker([center[1], center[0]], {
        icon: L.divIcon({
          className: 'summary-button',
          html: 'â–¼',
          iconSize: [20, 20]
        })
      }).addTo(map);

      summary.on('click', () => {
        const popup = L.popup()
          .setLatLng([center[1], center[0]])
          .setContent(`
            <div class='summary-box'>
              å»ºç¯‰æ•¸ï¼š${enriched.length} æ£Ÿï¼ˆå«æœªçŸ¥ï¼‰<br>
              æœ‰æ•ˆå»ºç¯‰æ•¸ï¼š${knownHeights.length} æ£Ÿ<br>
              å¹³å‡é«˜åº¦ï¼š<span id="avgHeightDisplay">${avg.toFixed(1)} m</span><br>
              æœ€é«˜ï¼š${max.toFixed(1)} mï¼Œæœ€ä½ï¼š${min.toFixed(1)} m<br>
              <button onclick="downloadJSON(${JSON.stringify(enriched).replace(/"/g, '&quot;')})">ä¸‹è¼‰çµæœ</button>
              <button onclick="enableHeightEdit()">æ›´æ–°å¹³å‡é«˜åº¦</button>
            </div>
          `).openOn(map);

        
      });
      storePolygonData(layer, geojson, enriched, avg); // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸

    } catch (err) {
      alert("æŸ¥è©¢å¤±æ•—ï¼š" + err);
    }
  });

  // æ¯æ–°å¢ä¸€å€‹ enriched polygon å°±åŠ åˆ°å…¨åŸŸè®Šæ•¸ä¸­ï¼ˆä½ åŸæœ¬åœ¨ CREATED è£¡çš„ enrichedï¼‰
  function storePolygonData(layer, geojson, enriched, avg) {
    const shape = {
      layer: layer,
      type: 'polygon',
      points: geojson.geometry.coordinates[0].map(p => ({
        x: p[0],
        y: p[1]
      })),
      zHeight: avg,
      isTarget: false,
      area: turf.area(geojson)
    };
    window.bboxProjectData.push(shape);
  }

  function getBoundingBox(coords) {
    const lats = coords.map(c => c[1]);
    const lngs = coords.map(c => c[0]);
    return {
      minLat: Math.min(...lats), maxLat: Math.max(...lats),
      minLng: Math.min(...lngs), maxLng: Math.max(...lngs)
    };
  }

  function downloadJSON(data, filename = 'osm_data.json') {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  // æš«æ™‚æ²’ç”¨åˆ°çš„å‡½æ•¸
  function updateAverageHeight() {
    const newAvg = parseFloat(document.getElementById('avgHeightInput').value);
    if (isNaN(newAvg)) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—");
        return;
    }
    alert("å·²æ›´æ–°å¹³å‡é«˜åº¦ç‚º " + newAvg.toFixed(1) + " m");

    // ä½ å¯ä»¥åœ¨é€™è£¡åšæ›´å¤šäº‹ï¼Œä¾‹å¦‚ï¼š
    // - æ›´æ–°åœ°åœ–ä¸Šçš„æ¨£å¼
    // - å„²å­˜åˆ°å¾Œç«¯
    // - æ›´æ–°æŸå€‹å…¨åŸŸè®Šæ•¸
    // ç›®å‰åªæ˜¯ç¤ºç¯„ alert
    }

    function enableHeightEdit() {
        const span = document.getElementById('avgHeightDisplay');
        const currentValue = parseFloat(span.innerText); // e.g., "32.0 m" â†’ 32.0
        span.innerHTML = `
            <input id="avgHeightInput" value="${currentValue}" style="width:60px;" />
        `;
        const input = document.getElementById('avgHeightInput');
        input.focus();

        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
            const newValue = parseFloat(input.value);
            if (isNaN(newValue)) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—");
                return;
            }
            span.innerText = `${newValue.toFixed(1)} m`;
            alert("å·²æ›´æ–°å¹³å‡é«˜åº¦ç‚º " + newValue.toFixed(1) + " m");

            // ğŸ”§ å¯é¸ï¼šå„²å­˜åˆ°æŸå€‹å€åŸŸè³‡æ–™ï¼Œä¾‹å¦‚ polygon.properties._custom_avg_height = newValue;
            }
        });
    }

    // å•Ÿå‹•æ¨™å®šæ¨¡å¼ï¼šæ›ä¸Š click listener ä¸¦æ›æ¸¸æ¨™
    function enableTargetMode() {
      drawnItems.eachLayer(layer => {
        layer.on('click', onTargetLayerClick);
        console.log('ç¶å®š click äº‹ä»¶åˆ° layer:', layer);
      });
      map.getContainer().style.cursor = 'crosshair';
    }

    // é»é¸å·²ç•«å¥½çš„å¤šé‚Šå½¢å¾Œï¼Œå°‡å…¶é‚Šæ¡†è®Šç´…ã€åŠ ä¸Š icon ä¸¦æ›´æ–° isTarget
    function onTargetLayerClick(e) {
      console.log('â–¶ layer è¢«é»æ“Š:', e.target);
      // å…ˆå–æ¶ˆæ‰€æœ‰ listener ä¸”æ¢å¾©åŸè‰²
      drawnItems.eachLayer(l => {
        l.off('click', onTargetLayerClick);
        l.setStyle({ color: '#0077cc' });
      });
      map.getContainer().style.cursor = '';

      const layer = e.target;
      layer.setStyle({ color: 'red' });

      // åœ¨ä¸­å¿ƒæ”¾ä¸€å€‹ target icon
      const center = layer.getBounds().getCenter();
      L.marker(center, {
        icon: L.divIcon({
          className: 'target-icon',
          html: 'ğŸ¯',
          iconSize: [24,24]
        })
      }).addTo(map);

      // æ›´æ–°è³‡æ–™é™£åˆ—è£¡çš„ isTarget
      const shape = window.bboxProjectData.find(s => s.layer === layer);
      if (shape) shape.isTarget = true;
    }


</script>
</body>
</html>